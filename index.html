<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Access</title>
  <style>
    :root { --radius: 16px; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      min-height: 100svh; margin: 0;
      display: grid; place-items: center;
      background: radial-gradient(circle at 20% 20%, #f2f6ff, #e9eef7 40%, #e6ecff 100%);
    }
    .card {
      width: min(420px, 92vw);
      background: #fff; border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 28px 24px;
    }
    h1 { margin: 0 0 8px; font-size: 1.25rem; }
    p.help { margin: 0 0 18px; color: #556; font-size: .95rem; }
    form { display: grid; gap: 12px; }
    input[type="password"] {
      padding: 12px 14px; border-radius: 12px; border: 1px solid #c9d3f0; font-size: 1rem;
      outline: none; transition: box-shadow .2s, border-color .2s;
    }
    input[type="password"]:focus { border-color: #7a95ff; box-shadow: 0 0 0 4px rgba(122,149,255,.15); }
    button {
      padding: 12px 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer;
      background: #6b86ff; color: white; font-size: 1rem; transition: transform .03s ease, filter .2s;
    }
    button:active { transform: translateY(1px); }
    .msg { min-height: 22px; font-size: .95rem; color: #d33; }
    .shake { animation: shake .3s linear 1; }
    @keyframes shake {
      0%,100% { transform: translateX(0) }
      25% { transform: translateX(-6px) }
      50% { transform: translateX(6px) }
      75% { transform: translateX(-4px) }
    }
    .footer { margin-top: 10px; font-size: .8rem; color: #667; text-align: center; }
  </style>
</head>
<body>
  <main class="card" id="card">
    <h1>접속 비밀번호</h1>
    <p class="help">비밀번호를 입력해주세요.</p>
    <form id="pw-form" autocomplete="off">
      <input id="pw" type="password" inputmode="numeric" placeholder="4자리 비밀번호" required minlength="1" />
      <button type="submit">입장</button>
      <div class="msg" id="msg"></div>
    </form>
    <div class="footer">보안을 위해 비밀번호는 해시로만 비교합니다.</div>
  </main>

  <script>
    // 평문 "0914"는 코드에 포함하지 않습니다.
    // "0914"의 SHA-256 해시(소문자 hex): 9fa4628f...e62da
    const STORED_SHA256_HEX = "9fa4628fdc8ab3695975e06f53074c98571548e2ad8f2ed6f5208859f30e62da";
    const form = document.getElementById("pw-form");
    const input = document.getElementById("pw");
    const msg = document.getElementById("msg");
    const card = document.getElementById("card");

    // 비밀번호 시도 횟수와 잠금 시간을 저장
    let attemptCount = 0;
    let lockUntil = 0;

    async function sha256Hex(text) {
      const enc = new TextEncoder().encode(text);
      const digest = await crypto.subtle.digest("SHA-256", enc);
      const bytes = new Uint8Array(digest);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";
      const value = input.value;
      if (!value) return;

      // 잠금 시간 확인
      const now = Date.now();
      if (now < lockUntil) {
        const remainingSecs = Math.ceil((lockUntil - now) / 1000);
        msg.textContent = `${remainingSecs}초 후에 다시 시도해주세요.`;
        input.value = "";
        return;
      }

      try {
        const hex = await sha256Hex(value);
        // 타이밍 공격 완화용 상수시간 비교
        let same = true;
        if (hex.length !== STORED_SHA256_HEX.length) {
          same = false;
        } else {
          let result = 0;
          for (let i = 0; i < hex.length; i++) {
            result |= hex.charCodeAt(i) ^ STORED_SHA256_HEX.charCodeAt(i);
          }
          same = (result === 0);
        }

        if (same) {
          // 세션 범위에서만 통과 표시 (탭 닫으면 초기화)
          sessionStorage.setItem("authOK", "1");
          location.href = "welcome.html";
        } else {
          msg.textContent = "비밀번호가 올바르지 않습니다.";
          card.classList.remove("shake"); // 재생성 위한 토글
          void card.offsetWidth;
          
          // 실패 횟수 증가 및 잠금 확인
          attemptCount++;
          if (attemptCount >= 5) {
            lockUntil = Date.now() + (60 * 1000); // 1분 잠금
            msg.textContent = "비밀번호를 5회 틀렸습니다. 1분 후에 다시 시도해주세요.";
            attemptCount = 0; // 카운트 초기화
          } else {
            msg.textContent = `비밀번호가 올바르지 않습니다. (${5 - attemptCount}회 남음)`;
          }
          card.classList.add("shake");
          input.value = "";
          input.focus();
        }
      } catch (err) {
        msg.textContent = "오류가 발생했습니다. 다시 시도해주세요.";
        console.error(err);
      }
    });

    // 편의: Enter 키 처리는 기본 submit으로 충분
  </script>
</body>
</html>
